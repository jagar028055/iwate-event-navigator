# システム仕様書（イベント収集システム）

## 1. 全体構成
- 収集層: アダプタ（rss|ics|api|html）＋フェッチャ（ETag/Last-Modified対応）
- 処理層: 正規化、重複排除、充実化（LLM補助オプション）
- 保管層: PostgreSQL（Event/Source/RunLog/Snapshotテーブル）、オブジェクトストレージ
- 配信層: REST/GraphQL API、ICS生成、検索エンジン同期（Typesense/Meilisearch）
- 管理/監視: メトリクス、ログ、通知、簡易管理UI

## 2. コンポーネント仕様
- Source Registry
  - フィールド: id, name, type(rss|ics|api|html), url, city, frequency, enabled, notes
  - 機能: 登録/更新/無効化、履歴管理
- Fetcher
  - HTTP/HTTPS、ETag/If-None-Match、Last-Modified/If-Modified-Since
  - レート制御、リトライ（指数バックオフ）
- Parsers
  - RSS/Atom: 標準フィールド抽出、enclosure/リンク正規化
  - ICS: DTSTART/DTEND/LOCATION/UID/URL などを抽出
  - API(JSON): マッピング定義に基づく抽出
  - HTML: CSSセレクタ/XPath、microdata/schema.org/Event優先
- Normalizer
  - 共通スキーマへマッピング、日付/タイムゾーン正規化、テキストクリーニング
- Deduplicator
  - キー（title_clean+date+venue）＋類似度（タイトル類似）でマージ
  - コンフリクトはレビュー待機キューに送る
- Enricher（任意）
  - カテゴリ推定（小モデル）、短文要約、住所→地名抽出
- Storage
  - PostgreSQL、必要に応じPostGISで座標型
  - スナップショットはオブジェクトストレージに保存しパス参照
  - PoCではローカル永続化: `var/snapshots/`（後述の命名規則）と`var/runlogs/`
- Publisher
  - REST/GraphQL、ICS生成、検索エンジンへインデックス
- Scheduler/Worker
  - cron/Queue（BullMQ/Celery等相当）、優先度/依存関係管理

## 3. データモデル（論理）
- Event
  - id, title, description, starts_at, ends_at, venue, city, lat, lon, category, price, organizer, source_url, source_id, dedupe_key, status(active|hidden|quarantine), created_at, updated_at, last_seen
- Source
  - id, name, type, url, city, frequency, enabled, notes, created_at, updated_at
- RunLog
  - id, source_id, started_at, finished_at, status(success|fail|partial), fetched_count, parsed_count, upserted_count, error_summary
- Snapshot
  - id, source_id, event_candidate_id(optional), url, content_path, fetched_at, etag, last_modified
- ReviewQueue
  - id, candidate_ids(list), reason(dedupe_conflict|missing_required|parse_error), created_at, resolved_at

## 4. インタフェース仕様（概要）
- REST（例）
  - GET /events?city=盛岡&from=2025-01-01&to=2025-01-31&category=music
  - GET /events/{id}
  - GET /events.ics?city=盛岡
  - POST /admin/sources （管理系は認証必須）
- Webhook/通知
  - 失敗/復旧/件数急減をSlack/メール通知

## 5. スケジューリング/レート制御
- frequency（high:3h, normal:12h, low:24–72h）
- サイト単位の同時実行を防止、robotsのcrawl-delayを尊重

## 6. エラーハンドリング
- 通信: タイムアウト/5xxは指数バックオフで最大N回再試行
- 解析: パース失敗はサンプルをスナップショット保存し隔離
- データ: 必須欠落はquarantine、後続処理停止

## 7. ロギング/監視
- 指標: 取得件数、失敗率、重複率、反映遅延、ソース別ヘルス
- 収集ジョブ/パーサ別の構造化ログ（source_id, run_id, stage, duration, error）

## 8. セキュリティ/コンプライアンス
- APIキー/管理認証、RBAC（最小権限）
- レート制限（IP/キー別）
- 出典URLの明示、権利表記、利用規約へのリンク

## 9. データ保持/ライフサイクル
- スナップショット: 90日保持（PoC）、長期は圧縮/アーカイブ
- イベント: 終了後180日でアーカイブ、検索は継続可

### 9.1 スナップショット/RunLog 永続化（PoC詳細）
- 保存先（ローカル）
  - スナップショット: `var/snapshots/{sourceId}/{YYYY-MM-DD}/{hash}.{html|json|ics}`
  - RunLog: `var/runlogs/{YYYY-MM-DD}/{runId}.json`
- 命名・内容
  - `hash`: 取得元本文のハッシュ（ETag相当の差分確認にも使用）
  - RunLogは`{source_id, started_at, finished_at, status, counts, error_summary, snapshot_paths[]}`を含む
- 取得時ヘッダ・差分
  - `If-None-Match`（ETag）/`If-Modified-Since`を送出、304時はスナップショットを新規保存しない
- 削除方針
  - 90日超のスナップショット/RunLogは日次で削除（のちにオブジェクトストレージへ移行）

### 9.2 robots/レート制御（補足）
- `User-Agent`を固定し、`robots.txt`を尊重（`crawl-delay`相当の遅延を適用）
- ホスト単位の同時実行数=1、バックオフは指数関数的に最大N回

## 10. ロールアウト計画
- PoC → 限定公開 → 本番最小 → 機能拡張
- KPIゲートを満たさない場合は次フェーズ凍結し是正
