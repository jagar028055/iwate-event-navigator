# 機能設計書（イベント収集システム）

## 1. ユースケース
- 管理者がソースを登録/更新/無効化する
- バッチがスケジュールに従って収集・正規化・重複排除を行う
- 失敗時に通知が飛び、管理者が再実行/修正する
- 利用者がAPI/ICSでイベントを取得する
- 編集者が重複/不備を管理UIで解消する

## 2. 主要機能一覧
- ソース管理
  - 一覧/検索/詳細/作成/編集/無効化
  - フィールド: name, type, url, city, frequency, enabled, notes
- 収集ジョブ
  - 手動実行、履歴表示、RunLogの詳細、スナップショット参照
- イベント管理（管理UI）
  - 一覧/検索/詳細、編集（title/description/venue等）、非表示切替
  - 重複マージUI（代表を選択、フィールド統合）
- レビューキュー
  - 理由別（重複/欠落/解析失敗）に対応、解決操作
- 通知/アラート
  - 失敗/復旧/急減/急増の検知とSlack/メール通知
- 配信
  - REST/GraphQL API、ICS出力、検索インデックス同期

## 3. 画面・API（概要）
- Web（管理）
  - /admin/sources: 一覧（name/type/frequency/enabled、稼働状況）
  - /admin/sources/{id}: 詳細（編集、テスト実行、履歴）
  - /admin/events: フィルタ（city/date/category/status）、編集/非表示
  - /admin/review: レビューキューの一覧/処理
- API（公開）
  - GET /events: フィルタ（city, from, to, category, q）
  - GET /events/{id}
  - GET /events.ics: city/from/to でカレンダー

## 4. フロー詳細
- 収集フロー
  1) schedulerがsource.enabledかつfrequency条件に合致したジョブを投入
  2) fetcherがIf-None-Match/If-Modified-Sinceで差分取得
  3) parserが候補イベントを抽出、normalizerで共通スキーマへ
  4) deduplicatorが既存と付き合わせ、merge/upsert
  5) enricher（任意）でカテゴリ/要約/ジオコーディング
  6) publisherが検索エンジン更新、ICSキャッシュ再生成
  7) runlog保存、メトリクス送出、失敗時は通知
- レビュー/修正フロー
  - レビューキューから個別イベントへ遷移し、編集/マージ/破棄を実行

## 5. バリデーション/品質ゲート
- 必須: title, starts_at, source_url
- starts_at < ends_at を保証
- 過去終了イベントは隔離（保持方針に従いアーカイブ）
- URL死活チェック（HEAD/GET）

## 6. 権限/認可
- ロール: admin, editor, viewer
- 管理系はadmin、レビューはeditor以上、公開APIはviewer（匿名）

## 7. 設定/構成
- sources.yaml（name, type, url, selectors(HTML時), mapping(API時), frequency, city, notes）
- env: DB接続、外部APIキー（LLM/Geocoding/検索）
 - LLM補助スイッチ（任意導入時）
   - `LLM_ENABLE_CLASSIFICATION`、`LLM_ENABLE_SUMMARY`、`LLM_ENABLE_GEOCODING` を true/false で制御
   - コスト管理のためデフォルトは無効、フェーズ4で有効化し効果測定

## 8. 運用・監視
- ダッシュボード: 取得件数、失敗率、重複率、反映遅延、サイト別ヘルス
- 週次レポート自動生成（Markdown/CSV）

## 9. フォールバック戦略
- RSS/ICSが壊れたらHTMLへ、HTMLが崩れたらPlaywrightによる動的取得を暫定適用
- 失敗が閾値超過で自動的にfrequencyを落とし、通知

## 10. ロードマップとの対応
- フェーズ1: ソース管理/収集/正規化/API/ICS/監視の最小
- フェーズ2: HTMLアダプタ/重複UI/検索連携の強化
- フェーズ3: 難所ソース/LLM補助/管理UI拡充
