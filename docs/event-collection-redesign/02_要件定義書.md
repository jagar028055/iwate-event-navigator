# 要件定義書（イベント収集システム再設計）

## 1. 目的・背景
- 目的: 岩手のイベント情報を正確・網羅的・監査可能に収集/配信する基盤を構築する。
- 背景: LLM単独収集は出典不明確・再現性低・コスト不安定。一次情報中心のETLへ移行する。

## 2. スコープ
- 対象: データ収集、正規化、重複排除、充実化（最小限LLM）、保存、配信、監視。
- 非対象: 既存フロントの大改修、決済、会員管理（必要になれば別途）。

## 3. 利害関係者
- プロダクトオーナー、開発・運用、編集/QA、利用者（一般/主催者）、法務・広報。

## 4. 用語定義
- イベント: 日時・場所・内容・主催が特定できる催し。
- ソース: 取得対象サイト/フィード（rss|ics|api|html）。
- スナップショット: 取得時の原文データ（HTML/RSS/JSON等）の保存物。

## 5. 前提/制約
- robots.txt/利用規約順守。レート制御必須。
- LLMは補助用途に限定。出典URLは必ず保存/表示。
- 1日あたり収集対象は当初10〜30サイト規模を想定。

## 6. 機能要件（FR）
- FR-01: ソース登録/更新/無効化を管理できる。
- FR-02: RSS/ICS/API/HTMLの4方式で収集できる。
- FR-03: 差分取得（ETag/Last-Modified/If-None-Match）に対応する。
- FR-04: 共通スキーマに正規化する（必須/任意フィールド）。
- FR-05: 重複排除（キー＋類似度）で同一イベントを統合する。
- FR-06: 品質ゲート（過去日付/必須欠落/死活NG）で隔離できる。
- FR-07: 住所→緯度経度のジオコーディングを行う（段階導入）。
- FR-08: LLM補助でカテゴリ推定/短文要約ができる（切替可能）。
- FR-09: 出典URL/スナップショットを保存し、監査できる。
- FR-10: 取得ジョブをスケジュール/手動実行/再実行できる。
- FR-11: 障害/失敗の通知（メール/Slack等）を送れる。
- FR-12: API（REST/GraphQLのいずれか）で配信できる。
- FR-13: ICSエクスポート（カレンダー購読）を提供できる。
- FR-14: 検索（全文/絞り込み）用に検索エンジンへ同期できる。
- FR-15: 管理UIでイベント編集/重複マージ/非表示を操作できる（段階導入）。

## 7. 非機能要件（NFR）
- NFR-01: 正確性（日時/場所/URL整合）≥ 99%。
- NFR-02: 新鮮度（重要ソースの反映）≤ 6h、通常 ≤ 24h。
- NFR-03: 可用性（API/収集）99.5%/月以上（小規模想定）。
- NFR-04: 性能（検索/一覧）p95 ≤ 300ms、API p95 ≤ 500ms。
- NFR-05: 拡張性（ソース追加は1日以内に可能）。
- NFR-06: 観測性（メトリクス/ログ/トレース）を標準装備。
- NFR-07: セキュリティ（API鍵、レート制限、監査ログ）。
- NFR-08: コスト上限（推論/外部API）を月額固定内に抑制。
- NFR-09: 法令/規約順守、出典表示、権利表記。

## 8. データ要件
- 必須: title, starts_at, source_url
- 強推奨: venue or city, ends_at, organizer
- 任意: description, price, lat/lon, category, tags
- 監査: source_id, last_seen, snapshot_path, fetched_at

## 9. 運用要件
- 定期実行スケジュール（高頻度/低頻度）を分離。
- フェイル/再試行ポリシー（指数バックオフ、最大N回）。
- 変更検知（DOM/構造差分）で通知。
- 月次レポート（取得件数/失敗率/重複率/KPI）。

## 10. 受け入れ基準
- 代表10〜15ソースで1週間連続稼働し、KPIを概ね達成。
- 主要イベントの欠落率が手動検証で5%以下。
- 障害時に通知が発報し、再実行で復旧することを確認。

## 11. 成果物
- 稼働する収集基盤（PoC→本番最小）
- ソースレジストリ（sources.yaml）と運用手順
- 開発/運用ドキュメント、管理UI（最小版）

## 12. 範囲外（明示）
- 高トラフィック向けの大規模スケール設計
- 有償APIの恒久契約（PoCでは無償/少額で検証）
